# mails4net
此项目将邮件系统作为网络传输层使用
## 应用场景
极其严苛的网络环境，仅开通了邮件服务端口
## 系统需求
1. Linux操作系统
1. IMAP邮件服务（不支持POP3）
1. 一个发件邮箱（可供多个发送端共用）
1. 一个收件邮箱（可供多个接收端共用）  
> 理论上，一个发送邮箱与一个接收邮箱足以满足所有应用场景；当然利用多个发送邮箱或多个接收邮箱更好，表现为更高的隔离度和更简洁的检索。

## 系统构成
1. 切片算法满足以下保证
   1. 任意两切片长度各不相同
   1. 产生尽可能少的切片
   1. 各切片长度类似
   1. 倒数第二块切片“最大”
   1. 倒数第一块切片“最小”
   1. 从第一至倒数第二块切片长度以“1”递增
   1. (倒数第一块长度) 大于或等于 (第一块长度减总块数)
1. 发送协议（邮件格式）需满足以下条件
   1. “切片文件名” 为 “原文名”+“.”+“切片序号”
   1. 邮件标题为“切片文件名”
   1. 邮件正文倒数第三行及以上为“供人阅读信息”
   1. 所有邮件正文倒数第二行及以上完全相同
   1. 邮件正文倒数第二行定义原文件
   1. 邮件正文倒数第一行定义切片文件
   1. 邮件包含的第一个附件为“切片文件”
1. 接收程序包含以下功能
   1. 清除（clear）“已下载标记”
   1. 设置（set）“已下载标记”
   1. 检查（check）邮件的完整性
   1. 获取（get）文件

## 安装
……

## 用法
* file2mails  
   * file2mails 原文件 切片长度上限 发件人 收件人 附加文件后缀 邮件正文 媒体类型（MIME）  
      * 切片长度上限
         * GMail发送（SMTP）建议值26214400
      * 发件人
         * 例：“'TEST &lt;alert@yayooo.com&gt;'”，可用于接收检索条件
      * 收件人
         * 多个邮箱之间以“,”号分隔
      * 附加文件后缀
         * 相当于将原文件名更名为“原文件名”+“后缀”，可省略，当收接收检索条件无法准确区分邮件（例如发信频率大于1次/天）时，建议使用此项，例：“$(date +.%Y%m%d%H%M%S)”
      * 邮件正文
         * 可省略，将成为邮件正文的第二行至倒数第三行，可用于接收检索条件
      * 媒体类型（MIME）
         * 设置正确的媒体类型以便于可以使用邮件服务商提供的预览等功能（但一般经切割后的文件都无法识别）
> 建议避开“跨天”、“整点”时刻发信，以免难以精确描述接收检索条件。

* mails2file：
    * mails2file 指令 邮件服务器 邮件服务用户名 邮件服务密码 邮件目录 接收端名 输出目录 原文件名 接收检索条件 切片列表
      * 邮件目录
        * 建议使用（例如：利用邮件服务商的过滤器功能，将邮件自动送入）“回收站”，以实现邮件自动汰旧及空间回收
      * 接收端名
        * 此接收程序的操作不仅受命令行控制，并受服务器上的邮件标记影响，“接收端名”即为在服务器上对此客户端的标识，所以同一组邮件可以由多个接收端相互独立的操作，亦实现了“多播”功能
      * 输出目录
        * 当下载失败，已下载的切片也将缓存于此，以备以后再次下载时复用
      * 切片列表
        * 可以通过（允许混用）两种方式来指定：1.邮件序号（IMAP_UID）；2.邮件标题（即“切片文件名”）。

# 指令
* 当clear指令却没有提供待清除的列表时，则：列出“早已下载过的邮件”，即“可被清除已下载标记的”
* 当set指令却没有提供待设置的列表时，则：列出“已准备好将要下载的邮件”，即“可被设置已下载标记的”
* clear指令或set指令显示结果三或四列：1.邮件序号；2.邮件标题；3.邮件时间；4.执行标记。
* clear指令或set指令对应的指令clear1或set1的显示则省略“邮件标题”和“邮件时间”列，以便于将clear1或set1的输出作为check或get的输入。
* 当check指令，则会显示当前可用的本地缓存
* 当get指令，如遇故障则会保留缓存
* check或get指令支持两种工作模式：1.明确指定模式；2.邮件标记模式。
  * 当“切片列表”全为数字（邮件序号）时，为“明确指定模式”（此时将完全忽略接收检索条件和服务器上邮件标记）；否则为“邮件标记模式”（此时将完全忽略切片列表）。

# 工作流
* 正常（新邮件）
  * 接收检索条件+get指令 => 获取文件
* 复杂
  * 接收检索条件+clear或set指令 => 邮件序号 +check或get指令 => 获取文件

# 缓存
  接收程序可利用三路缓存：“原文件名”、“原文件名.tmp”、“切片文件名”
* 缓存生成
  * 当下载开始，数据会先写入“原文件名.tmp”，如下载中遇到邮件缺失，则后续数据会写入对应的“切片文件名”中。所以下载失败后，目标目录中将会存留：一个“原文件名.tmp”，包含前面多个切片；和后面多个“切片文件名”。当然，你可以自行下载邮件附件，放入目标目录中。
* 缓存的检查
  * check指令结果的第六列显示已校验通过的可用缓存。
* 缓存复用
  * 再次获取文件时，接收程序会依次优先复用“原文件名.tmp”、“原文件名”、“切片文件名”中的数据，所有缓存均先通过校验才会被复用（存在的文件已损坏也无需担心），本地无法找到正确数据最后才会通过网络获取。
* 缓存清理
  * 目标目录除上述三个文件名外，还可能有：“切片文件名.deleted”（校验正确且已汇入“原文件名.tmp”）、“切片文件名.bad_size”、“切片文件名.bad_hash”。

# check（检查）指令
```Bash
mails2file check ……
95321	1725	tor.7z.01	2017-04-11T03:53:05+0800	1491853985956770657@vk0cyzdtr9ki.net	/tmp/tor.7z.tmp
95322	1726	tor.7z.02	2017-04-11T03:53:05+0800	1491853985981893214@vk0cyzdtr9ki.net	/tmp/tor.7z.tmp
95323
95324	1728	tor.7z.04	2017-04-11T03:53:06+0800	1491853986028523881@vk0cyzdtr9ki.net	/tmp/tor.7z
95325	1729	tor.7z.05	2017-04-11T03:53:06+0800	1491853986051291231@vk0cyzdtr9ki.net	/tmp/tor.7z
95326	1730	tor.7z.06	2017-04-11T03:53:06+0800	1491853986074074294@vk0cyzdtr9ki.net
95327	1731	tor.7z.07	2017-04-11T03:53:06+0800	1491853986099285708@vk0cyzdtr9ki.net
95328	1735	tor.7z.08	2017-04-11T03:53:06+0800	1491853986123927870@vk0cyzdtr9ki.net	/tmp/tor.7z.08
95329	1732	tor.7z.09	2017-04-11T03:53:06+0800	1491853986145791770@vk0cyzdtr9ki.net	/tmp/tor.7z.09
95330	1733	tor.7z.10	2017-04-11T03:53:06+0800	1491853986171565106@vk0cyzdtr9ki.net
95318	1734	tor.7z.11	2017-04-11T03:53:06+0800	1491853986195853689@vk0cyzdtr9ki.net	/tmp/tor.7z.11
INCOMPLETE_MAILS=10<11=EXPECTED at mails2file line 434.
```
```Bash
ls -l /tmp/tor.7z.tmp /tmp/tor.7z /tmp/tor.7z.08 /tmp/tor.7z.09 /tmp/tor.7z.11
-rw-r--r-- 1 root root 238304 Apr 11 04:15 /tmp/tor.7z.tmp
-rw-r--r-- 1 root root 524278 Apr 11 04:15 /tmp/tor.7z
-rw-r--r-- 1 root root  95328 Apr 11 04:15 /tmp/tor.7z.08
-rw-r--r-- 1 root root  95329 Apr 11 04:15 /tmp/tor.7z.09
-rw-r--r-- 1 root root  95318 Apr 11 04:15 /tmp/tor.7z.11
```
* 第一列为推算的切片长度。
* 第二列为邮件序号（IMAP_UID）（不保证连续，也不保证递增）。
* 第三列为切片名。
* 第四列为发信时间。
* 第五列为邮件Message-ID。
* 第六列为通过校验的缓存。
* 在服务器上找不到长度为95323（第03）切片对应的邮件（在此问题解决之前，不可能完成下载）。
* 第01、02切片在本地已有缓存，它俩缓存都是“/tmp/tor.7z.tmp”文件（其长度大于或等于前两片之合）。
* 第04、05切片在本地已有缓存，它俩缓存都是“/tmp/tor.7z”文件（其长度大于或等于前五片之合）。
* 第06、07、10切片没有本地缓存，需要下次从网上下载。
* 第08、09、11切片在本地已有缓存，缓存文件分别对应“/tmp/tor.7z.08”、“/tmp/tor.7z.09”、“/tmp/tor.7z.11”。

## 邮件服务商
  * GMail
    * 实测附件长度=26221016，曾可正常发送&接收，实际还受邮件正文等长度的影响。
      * “TEXT”检索条件非完全匹配（估计为全文索引），相同的匹配方式，会受被检索输入值（分词算法）影响，可能漏检出，也可能余检出，并不完全可靠（例如：“TEXT 20170407T19:04:15.375830638+”可检出“20170407T19:32:15.375830638+0800”）！
      * 可对“20170123T12:”、“20170123T12:34:”、“20170123T12:34:56.123456789”、“20170123T12:34:56.123456789+0800”，检索；但不可对“20170123T12:34:56”，检索。
  * 139.com
    * “TEXT”检索条件完全无效，“FROM”无法将邮件地址前部的“显示名”作为检索条件，“TO”只对实用的139.com地址有效，“SUBJECT”有效

  * exmail.qq.com
    * 服务器中的大部分不支持IMAP协议中的“KEYWORD”、“UNKEYWORD”检索指令
    * 似乎所有服务器都不支持“邮件标记”

## 故障释义
  * IMAP_LOGIN_FAILED
    * 邮件服务器登录失败
  * IMAP_SEARCH_COMMAND
    * 邮件服务器的检索命令执行失败，请检查“接收检索条件”是否正确
  * INVALID_MAIL_IMAP_UIDs
    * 邮件服务器上不存在所指定的“邮件序号”
  * NOTHING_MATCHED
    * “接收检索条件”（过于狭窄）没能检索出任何邮件
  * LISTED_BUT_NOT_MATCHED
    * “接收检索条件”检索出的结果不包含命令行所指定的“切片列表”
  * MAIL_SUBJECT_NOT_MATCHED
    * 检索出的邮件与命令行所指定的“原文件名”不符
  * MAIL_BODY_NOT_UNIFORM
    * 各个邮件正文倒数第二行及以上并不完全一致
  * EXCESSIVE_MAILS
    * 下载列表邮件个数大于推算出的邮件个数
  * SIZE_ARRAY_NOT_UNIFORM
    * 不同的邮件推算出不同的切片序列
  * INCOMPLETE_MAILS
    * 下载列表邮件个数小于推算出的邮件个数
  * MAILS_SIZE
    * 已下载的邮件附件总长度与邮件中注明的原文件长度不一致
  * FILE_SIZE
    * 已写入的临时文件总长度与邮件中注明的原文件长度不一致
  * FILE_SHA512
    * 已写入的临时文件校验值与邮件中注明的原文件校验值不一致

## FAQ
1. 为何“邮件标记模式”设计为受邮件服务器上的邮件标记影响，而不是直接由命令行指定得了？
   * 因为“切片文件名”允许多次复用，不保证唯一，当接收检索条件不足以阐明下载意图时会造成混淆。所以，需要服务器上的邮件标记来唯一明确的指定一组邮件，亦有利于自动化。缺点是，非正常状态时，操作会多繁杂一步：须先指定邮件，后才能获取文件。
1. 为何要限于此切片算法，用别的方式切片，例如等分不行吗？
   * 因为此切片算法相当于实现了“自同步编码”，得到了一个切片封装，可推算出整个切片序列，提供良好的校验，才可有效复用缓存。
1. 当一组邮件不完整，例如缺少了一封，而此服务器上丢失的切片，在本地已有缓存，还能完成下载吗？
   * 不能。因为服务器上丢失的不仅是“切片文件（邮件附件）”，还包括“切片封装（邮件正文）”，而本地缓存中仅有“切片文件”。补救措施：再发一封邮件，可以没有附件，但邮件正文（除切片文件时间外）必须和丢失前的一样。
1. 当已知切片封装的三个信息：总长度、切片长度、切片序号，可推算出整个切片序列；那么如果仅知道两信息：总长度、切片长度，还能否推算出整个切片序列？
   * 不能。例如：总长度=6、切片长度=2，那么可能的解为：（2、3、1）或（4、2），可见解不唯一。
1. 既然：邮件正文倒数第三行及以上为“供人阅读信息”，那为何还需要每个切片邮件都相同？
   * 虽然说是“供人阅读信息”，实际还同时可以是“接收检索条件”，为何保证所有切片都被一致的检出或不检出，所以要求邮件正文（几乎）一致。
1. 为何QQ信箱总是报“IMAP_SEARCH_COMMAND”错？
   * 因为QQ邮件服务器中的大部分不支持IMAP协议中的“KEYWORD”、“UNKEYWORD”检索指令。（C：“UID SEARCH KEYWORD K1”；S：“BAD UID SEARCH invalid argument”。）

